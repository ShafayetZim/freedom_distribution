{% extends 'base.html' %} {% load static %} {% load humanize %} {% block pageContent %}
<section class="py-4">
<div class="container">
     <h3 class="fw-bolder text-center">Deliveryman Report</h3>
        <center>
            <hr class="bg-primary opacity-100" style="height:3px" width="5%">
        </center>
<!--    <div class="card rounded-0 mb-3">-->
<!--        <div class="card-header py-1">-->
<!--            <div class="card-title mb-0">Add Monthly Commission Bill</div>-->
<!--        </div>-->
<!--        <div class="card-body">-->
<!--            <div class="container-fluid">-->
<!--                <div class="text-end mb-1">-->
<!--                    <button-->
<!--                      class="btn btn-sm btn-primary rounded-0 bg-gradient-primary"-->
<!--                      type="button"-->
<!--                      id="create_new"-->
<!--                    >-->
<!--                      <i class="fa fa-plus"></i> Add New-->
<!--                    </button>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
        <div class="card rounded-0 mb-3">
            <div class="card-header py-1">
                <div class="card-title mb-0">Filter Deliveryman Report</div>
            </div>
            <div class="card-body">

                <form method="GET">
                <section class="site_filter">
                <div class="container-fluid">
                    <div class="row justify-content-center">


                        <div class="col">
                            <div class="form-group">
                                <label for="date">Start Date</label>
                                <input type="date" class="form-control mr-sm-3" id="start_date" name="start_date"
                                       value={{start_date}} required>

                            </div>
                        </div>

                        <div class="col">
                            <div class="form-group">
                                <label for="date">End Date</label>
                                <input type="date" class="form-control mr-sm-3" id="end_date" name="end_date"
                                       value={{end_date}} required>

                            </div>
                        </div>

                        <div class="col">
                            <div class="form-group">
                                <label for="deliveryman">Check Deliveryman</label>
                                <select class="form-control" id="check_deliveryman" name="check_deliveryman">
                                    <option disabled selected value="">Select Deliveryman</option>
                                    <option value="All">All</option>
                                    {% for item in deliveryman %}
                                    <option value="{{item.pk}}">{{item.name}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                    </div>
                </div>
            </section>

            <div class="text-center mt-3">
                <button class="btn btn-success">View</button>
            </div>
        </form>
            </div>
    </div>

    <div class="card rounded-0 shadow">
            <div class="card-body">
                <div class="container-fluid">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tbody>
                        <tr>
                        </tr>
                        <tr>
                            <td style="width: 30%;"><h6>Date Range: {{start_date }} To {{end_date}}</h6></td>
                            <td style="width: 30%;">&nbsp;</td>
                            <td style="width: 30%;  text-align: right;">
                            </td>
                        </tr>

                        </tbody>
                    </table>

                    <h6>Sales Summary</h6>
                    <table class="table table-bordered table-striped" style="border-collapse: collapse; width: 100%;" border="1" cellpadding="8">
                        <tbody>
                        <tr>
                            <td style="width: 5%;text-align:center;"><strong>SL</strong></td>
                            <td style="width: 20%;text-align:center;"><strong>Brand</strong></td>
                            <td style="width: 15%;text-align:center;"><strong>Amount</strong></td>

                        </tr>
                         {% for item in trade %}
                        <tr>
                            <td style="width: 10%;">
                                {{forloop.counter}}
                            </td>
                            <td style="width: 50%;">
                                {{item.brand}}
                            </td>
                            <td style="width: 40%;">
                                <input type="text" class="input-fields-to-sum form-control form-control-sm rounded-0" name="qty" id="qty" value="{{item.sum}}" readonly>
                            </td>

                        </tr>
                        {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="2" class="text-end">Total amount</th>
                                <th class="text-start fw-bolder">
                                    <input type="text" class="form-control form-control-sm rounded-0 total" name="total_qty" id="total_qty" value="" readonly>
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
    </div>
    {% if due %}
    <div class="card rounded-0 shadow">
            <div class="card-body">
                <div class="container-fluid">
                    <h6>Client Dues Summary</h6>
                    <table class="table table-bordered table-striped" style="border-collapse: collapse; width: 100%;" border="1" cellpadding="8">
                        <tbody>
                        <tr>
                            <td style="width: 5%;text-align:center;"><strong>SL</strong></td>
                            <td style="width: 20%;text-align:center;"><strong>Client</strong></td>
                            <td style="width: 15%;text-align:center;"><strong>Dues</strong></td>

                        </tr>
                         {% for item in due %}
                        <tr>
                            <td style="width: 10%;">
                                {{forloop.counter}}
                            </td>
                            <td style="width: 50%;">
                                {{item.client__name}}
                            </td>
                            <td style="width: 40%;">
                                <input type="text" class="due-fields-to-sum form-control form-control-sm rounded-0" name="due" id="due" value="{{item.sum}}" readonly>
                            </td>

                        </tr>
                        {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="2" class="text-end">Total amount</th>
                                <th class="text-start fw-bolder">
                                    <input type="text" class="form-control form-control-sm rounded-0 due_total" name="due_total" id="due_total" value="" readonly>
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
    </div>
    {% endif %}
    {% if commission %}
    <div class="card rounded-0 shadow">
            <div class="card-body">
                <div class="container-fluid">
                    <h6>Commission Summary</h6>
                    <table class="table table-bordered table-striped" style="border-collapse: collapse; width: 100%;" border="1" cellpadding="8">
                        <tbody>
                        <tr>
                            <td style="width: 5%;text-align:center;"><strong>SL</strong></td>
                            <td style="width: 20%;text-align:center;"><strong>Brand</strong></td>
                            <td style="width: 15%;text-align:center;"><strong>Commission</strong></td>

                        </tr>
                         {% for item in commission %}
                        <tr>
                            <td style="width: 10%;">
                                {{forloop.counter}}
                            </td>
                            <td style="width: 50%;">
                                {{item.brand__name}}
                            </td>
                            <td style="width: 40%;">
                                <input type="text" class="commission-fields-to-sum form-control form-control-sm rounded-0" name="commission" id="commission" value="{{item.sum}}" readonly>
                            </td>

                        </tr>
                        {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="2" class="text-end">Total amount</th>
                                <th class="text-start fw-bolder">
                                    <input type="text" class="form-control form-control-sm rounded-0 commission_total" name="commission_total" id="commission_total" value="" readonly>
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
    </div>
    {% endif %}

    <div class="card rounded-0 shadow mb-3">
            <div class="card-body">
                <div class="container-fluid">
                    <h6>Other Summary</h6>
                    <table class="table table-bordered table-striped" style="border-collapse: collapse; width: 100%;" border="1" cellpadding="8">

                        <tbody>
                            <tr>
                                <th colspan="2" class="text-end">Total Damage Return</th>
                                <th class="text-start fw-bolder">
                                    <input type="text" class="damage-fields-to-sum form-control form-control-sm rounded-0 damage_total" name="damage_total" id="damage_total" value="{{amount}}" readonly>
                                </th>
                                <th colspan="2" class="text-end">Total Cost</th>
                                <th class="text-start fw-bolder">
                                    <input type="text" class="cost-fields-to-sum form-control form-control-sm rounded-0 cost_total" name="cost_total" id="cost_total" value="{{cost}}" readonly>
                                </th>
                            </tr>
                            <tr>
                                <th colspan="2" class="text-end">Total Extra</th>
                                <th class="text-start fw-bolder">
                                    <input type="text" class="cost-fields-to-sum form-control form-control-sm rounded-0 extra_total" name="extra_total" id="extra_total" value="{{extra}}" readonly>
                                </th>
                                <th colspan="2" class="text-end">Total Paid</th>
                                <th class="text-start fw-bolder">
                                    <input type="text" class="cost-fields-to-sum form-control form-control-sm rounded-0 paid_total" name="paid_total" id="paid_total" value="{{paid}}" readonly>
                                </th>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
    </div>
</div>
</section>
 {% endblock pageContent %} {% block ScriptBlock %}
<script>
  $(function () {
    $("#create_new").click(function () {
      uni_modal(
        "<i class='fa fa-plus'></i> Add New Bill",
        "{% url 'manage-commission-bill' %}"
      );
    });
    $(".edit-data").click(function () {
      uni_modal(
        "<i class='fa fa-edit'></i> Edit Commission bill Details",
        $(this).attr("data-url")
      );
    });
    $(".view_image").click(function () {
      var img = $(this).attr("data-img-url");
      $("#viewer_modal #img-viewer-field").attr("src", img);
      $("#viewer_modal").modal("show");
    });
    $(".delete-data").click(function () {
      _conf("Are you sure to delete this Bill?", "delete_bill", [
        "'" + $(this).attr("data-url") + "'",
      ]);
    });
    $('#check_deliveryman').select2({
        placeholder: "Please Select Deliveryman Here",
        width: "100%",
        selectionCssClass: "form-control form-control-sm rounded-2"
    })
    $("#product-tbl").find("td, th").addClass("px-2 py-1 align-middle");
    $("#product-tbl").DataTable({
      columnDefs: [
        {
          orderable: false,
          targets: [4],
        },
      ],
      lengthMenu: [
        [25, 50, 100, -1],
        [25, 50, 100, "All"],
      ],
    });
  });

  function delete_bill(url) {
    var _this = $("#confirm_modal .modal-body");
    $(".err-msg").remove();
    var el = $("<div>");
    el.addClass("alert alert-danger err-msg");
    el.hide();
    start_loader();
    $.ajax({
      headers: {
        "X-CSRFToken": "{{csrf_token}}",
      },
      url: url,
      dataType: "JSON",
      error: (err) => {
        console.log(err);
        alert("an error occurred.");
        end_loader();
      },
      success: function (resp) {
        if (resp.status == "success") {
          location.reload();
        } else if (!!resp.msg) {
          el.html(resp.msg);
          _this.prepend(el);
          el.show();
        } else {
          el.html("An error occurred");
          _this.prepend(el);
          el.show();
        }
        end_loader();
      },
    });
  }


$(document).ready(function() {
   calculateTotals();

    $(".input-fields-to-sum").on('input', function() {
        calculateTotals();
    });
    $(".input-box-to-sum").on('input', function() {
        calculateTotals();
    });
    $(".due-fields-to-sum").on('input', function() {
        calculateTotals();
    });
    $(".commission-fields-to-sum").on('input', function() {
        calculateTotals();
    });
});

function calculateTotals() {
   // walk on input fields with class, calculate sum and put it in total field
   // input can contain invalid numbers, handle errors when parsing
    var arr = document.getElementsByClassName('input-fields-to-sum');
    var arr2 = document.getElementsByClassName('input-box-to-sum');
    var arr3 = document.getElementsByClassName('due-fields-to-sum');
    var arr4 = document.getElementsByClassName('commission-fields-to-sum');
    var tot1=0;
    var tot2=0;
    var tot3=0;
    var tot4=0;
        for(var i=0;i<arr.length;i++){
            if(parseFloat(arr[i].value))
                tot1 += parseFloat(arr[i].value);
        }
        for(var i=0;i<arr2.length;i++){
            if(parseFloat(arr2[i].value))
                tot2 += parseFloat(arr2[i].value);
        }
        for(var i=0;i<arr3.length;i++){
            if(parseFloat(arr3[i].value))
                tot3 += parseFloat(arr3[i].value);
        }
        for(var i=0;i<arr4.length;i++){
            if(parseFloat(arr4[i].value))
                tot4 += parseFloat(arr4[i].value);
        }

    var result = (tot1);
    $("#total_qty").val(result);
    $("#total").val(tot2);
    $("#due_total").val(tot3);
    $("#commission_total").val(tot4);
}

function parseNumber(str, defaultValue) {
    if (str !== undefined && str.length) {
        var parsed = parseFloat(str.replace(',','.').replace(/\s/g,'').replace(/\&nbsp\;/g,''));
        if (isNaN(parsed)) return defaultValue;
        return parsed;
    }
    return defaultValue;
}

</script>
{% endblock ScriptBlock %}