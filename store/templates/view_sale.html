{% extends 'base.html' %}{% load static %}{% load humanize %}{% block pageContent %}
<style>
    #laundry-img {
        max-width: 100%;
        max-height: 10em;
        object-fit: scale-down;
        object-position: center center;
    }
</style>
<section class="py-4">
    <div id="printableArea">
    <div class="container">
        <div class="card rounded-0 mb-3">
            <div class="card-header py-1">
                <div class="d-flex w-100">
                    <div class="col-auto flex-shrink-1 flex-grow-1">
                        <div class="card-title mb-0 py-1">Sale Transaction Details</div>
                    </div>
                    <div class="col-auto flex-shrink-1 flex-grow-1">
                        <img
                              src="../static/assets/default/img/FreedomDistributionCopy.png"
                              height="50px"
                              alt="{{ MEDIA_URL }}"
                              loading="lazy"
                              class="bg-white bg-gradient px-1 py-1"
                              style="width:4em;height:4em;"
                        />
                    </div>
                    <div class="col-auto noPrint">
                        {% if sale.status == '0' %}
                        <small class="badge badge-secondary bg-gradient bg-secondary px-3 rounded-pill bg-opacity-75 text-sm py-1">Pending</small> {% elif laundry.status == '1' %}
                        <small class="badge badge-primary bg-gradient bg-primary px-3 rounded-pill bg-opacity-75 text-sm py-1">In-Progress</small> {% elif laundry.status == '2' %}
                        <small class="badge badge-success bg-gradient bg-success px-3 rounded-pill bg-opacity-75 text-sm py-1">Done</small> {% elif laundry.status == '3' %}
                        <small class="badge badge-warning bg-gradient bg-warning px-3 rounded-pill bg-opacity-75 text-sm py-1">Picked Up</small> {% else %}
                        <small class="badge badge-light bg-gradient bg-light px-3 border rounded-pill bg-opacity-75 text-sm py-1">N/A</small> {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="container-fluid" id="client-details">
                    {% if sale.code %}
                    <div class="row">
                        <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                            <label for="" class="control-label">Transaction Code</label>
                            <div class="h5"><b>{{sale.code}}</b></div>
                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                            <label for="road" class="control-label">Road</label>
                            <div class=""><b>{{sale.road}}</b></div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="row">
                        <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                            <label for="salesman" class="control-label">Salesman</label>
                            <div class=""><b>{{sale.salesman}}</b></div>
                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                            <label for="deliveryman" class="control-label">Deliveryman</label>
                            <div class=""><b>{{sale.deliveryman}}</b></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if pitems %}
        <div class="card rounded-0 mb-3">
            <div class="card-header py-1">
                <div class="card-title mb-0 py-1">Sale Items  List</div>
            </div>
            <div class="card-body">
                <div class="container-fluid">
                    <table class="table table-bordered" id="product_list">
                        <colgroup>
                            <col width="30%">
                            <col width="15%">
                            <col width="10%">
                            <col width="10%">
                            <col width="10%">
                            <col width="10%">
                            <col width="15%">
                        </colgroup>
                        <thead>
                            <tr>
                                <th class="p-1 text-center">Product Name</th>
                                <th class="p-1 text-center">Unit Price</th>
                                <th class="p-1 text-center">Quantity</th>
                                <th class="p-1 text-center">Free</th>
                                <th class="p-1 text-center">Good</th>
                                <th class="p-1 text-center">Damage</th>
                                <th class="p-1 text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pitem in pitems %}
                            <tr>
                                <td class="px-2 py-1 align-middle product_type">{{pitem.product.name}}</td>
                                <td class="px-2 py-1 align-middle text-end product_price">{{pitem.price|floatformat:2}}</td>
                                <td class="px-2 py-1 align-middle text-center">{{pitem.quantity|floatformat}}</td>
                                <td class="px-2 py-1 align-middle text-center">{{pitem.free_quantity|floatformat}}</td>
                                <td class="px-2 py-1 align-middle text-center">{{pitem.good_quantity|floatformat}}</td>
                                <td class="px-2 py-1 align-middle text-center">{{pitem.damage_quantity|floatformat}}</td>
                                <td class="px-2 py-1 align-middle product_total text-end">{{pitem.total_amount|floatformat:2}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-center" colspan="6">Total</th>
                                <th class="text-end sub-total-product">{{sale.totalProducts|floatformat:2|intcomma}}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if ritems %}
        <div class="card rounded-0 mb-3">
            <div class="card-header py-1">
                <div class="card-title mb-0 py-1">Return Items List</div>
            </div>
            <div class="card-body">
                <div class="container-fluid">
                    <table class="table table-bordered" id="return_list">
                        <colgroup>
                            <col width="40%">
                            <col width="20%">
                            <col width="20%">
                            <col width="20%">
                        </colgroup>
                        <thead>
                            <tr>
                                <th class="p-1 text-center">Product Name</th>
                                <th class="p-1 text-center">Unit Price</th>
                                <th class="p-1 text-center">Quantity</th>
                                <th class="p-1 text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pitem in ritems %}
                            <tr>
                                <td class="px-2 py-1 align-middle product_type">{{pitem.product.name}}</td>
                                <td class="px-2 py-1 align-middle text-end product_price">{{pitem.price|floatformat}}</td>
                                <td class="px-2 py-1 align-middle text-center">{{pitem.quantity|floatformat}}</td>
                                <td class="px-2 py-1 align-middle product_total text-end">{{pitem.total_amount|floatformat}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-center" colspan="3">Total</th>
                                <th class="text-end sub-total-product">{{sale.totalReturns|floatformat:2|intcomma}}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if items %}
        <div class="card rounded-0 mb-3">
            <div class="card-header py-1">
                <div class="card-title mb-0 py-1">Client Dues List</div>
            </div>
            <div class="card-body">
                <div class="container-fluid">
                    <table class="table table-bordered" id="laundry_list">
                        <colgroup>
                            <col width="20%">
                            <col width="22%">
                            <col width="22%">
                            <col width="12%">
                            <col width="12%">
                            <col width="12%">
                        </colgroup>
                        <thead>
                            <tr>
                                <th class="p-1 text-center">Client Name</th>
                                <th class="p-1 text-center">Brand Name</th>
                                <th class="p-1 text-center">Note</th>
                                <th class="p-1 text-center">Dues</th>
                                <th class="p-1 text-center">Paid</th>
                                <th class="p-1 text-center">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr>
                                <td class="px-2 py-1 align-middle laundry_type">{{item.client.name}}</td>
                                <td class="px-2 py-1 align-middle">{{item.brand}}</td>
                                <td class="px-2 py-1 align-middle">{{item.note}}</td>
                                <td class="px-2 py-1 align-middle text-end laundry_price">{{item.due|floatformat:2}}</td>
                                <td class="px-2 py-1 align-middle text-center">{{item.paid|floatformat:2}}</td>
                                <td class="px-2 py-1 align-middle laundry_total text-end">{{item.balance|floatformat:2}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-center" colspan="5">Total</th>
                                <th class="text-end sub-total-laundry">{{sale.totalItems|floatformat:2|intcomma}}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if bitems %}
        <div class="card rounded-0 mb-3">
            <div class="card-header py-1">
                <div class="card-title mb-0 py-1">Brand Commission List</div>
            </div>
            <div class="card-body">
                <div class="container-fluid">
                    <table class="table table-bordered" id="commission_list">
                        <colgroup>
                            <col width="40%">
                            <col width="20%">
                            <col width="20%">
                            <col width="20%">
                        </colgroup>
                        <thead>
                            <tr>
                                <th class="p-1 text-center">Brand Name</th>
                                <th class="p-1 text-center">Commission</th>
                                <th class="p-1 text-center"></th>
                                <th class="p-1 text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in bitems %}
                            <tr>
                                <td class="px-2 py-1 align-middle laundry_type">{{item.brand.name}}</td>
                                <td class="px-2 py-1 align-middle text-end laundry_price">{{item.commission|floatformat}}</td>
                                <td class="px-2 py-1 align-middle text-center">{{item.paid|floatformat}}</td>
                                <td class="px-2 py-1 align-middle brand_total text-end">{{item.total_amount|floatformat:2}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th class="text-center" colspan="3">Total</th>
                                <th class="text-end sub-total-product">{{sale.totalCommissions|floatformat:2|intcomma}}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card rounded-0 mb-3">
            <div class="card-body">
                <div id="payment-details">
                    <div class="d-flex w-100 justify-content-end align-items-center">
                        <div class="col-auto">
                            <h4 class="fw-bolder text-muted pe-2">Grand Total:</h4>
                        </div>
                        <div class="col-lg-4 col-md-6 col-sm-12 col-xs-12 text-end">
                            <h4 class="fw-bolder pe-2 gtotal">{% if laundry.total_amount %}{{laundry.total_amount|floatformat:2|intcomma}}{% else %}0.00{% endif %}</h4>
                        </div>
                    </div>
                    <div class="d-flex w-100 justify-content-end align-items-center">
                        <div class="col-auto">
                            <h4 class="fw-bolder text-muted pe-2">Tendered Amount:</h4>
                        </div>
                        <div class="col-lg-4 col-md-6 col-sm-12 col-xs-12 text-end">
                            <h4 class="fw-bolder pe-2">{% if laundry.tendered %}{{laundry.tendered|floatformat:2|intcomma}}{% else %}0.00{% endif %}</h4>
                        </div>
                    </div>
                    <div class="d-flex w-100 justify-content-end align-items-center">
                        <div class="col-auto">
                            <h4 class="fw-bolder text-muted pe-2">Change:</h4>
                        </div>
                        <div class="col-lg-4 col-md-6 col-sm-12 col-xs-12 text-end">
                            <h4 class="fw-bolder pe-2 " id="change">{% if laundry.change %}{{laundry.change|floatformat:2|intcomma}}{% else %}0.00{% endif %}</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="noPrint card-footer py-1 text-center">
                <input type="button" onclick="printDiv('printableArea')" value="print a div!" />
                <button class="btn btn-primary bg-primary btn-sm rounded-0" id="update-status" type="button">Update Status</button>
                <a class="btn btn-primary bg-gradient bg-primary btn-sm rounded-0" href="{% url 'manage-sale-pk' sale.pk %}"><i class="fa fa-edit"></i> Edit</a>
                <button class="btn btn-danger bg-gradient bg-danger btn-sm rounded-0" type="button" id="delete-data"><i class="fa fa-trash"></i> Delete</button>
                <button class="btn btn-success bg-gradient bg-success  btn-sm rounded-0" type="button" id="print"><i class="fa fa-print"></i> Print</button>
                <a class="btn btn-light bg-gradient bg-light border btn-sm rounded-0" href="{% url 'sale-page' %}"><i class="fa fa-angle-left"></i> Back to List</a>
            </div>
        </div>
    </div>
    </div>
</section>
<noscript id="print-header">
<div>
    <style>
        html{
            min-height: unset !important;
        }
    </style>
    <div class="d-flex w-100">
        <div class="col-2 text-center">
<!--            <img src="{{system_host}}{% static 'assets/default/img/FreeDis.png' %}" style="width:4em;height:4em;object-fit:cover;object-position:center center" alt="" class="p-0 img-thumbnail">-->
        </div>
        <div class="col-8">
                <div class="lh-1">
                    <h4 class="text-center mb-0 fw-bolder">{{system_name}}</h4>
                    <p class="text-center mb-0">Your Trusted Business Partner...</p>
                    <p class="text-center mb-0">16 Moharaza Rd, Mymensingh 2200</p>
                    <h6 class="text-center mb-0 fw-bolder">Pro: A. K. M. Nuruzzaman (Rakib)</h6><br />
<!--                    <h5 class="text-center mb-0 fw-bolder">Fresh Product Report</h5>-->
                </div>
            </div>
    </div>
    <hr>
</div>
</noscript> {% endblock pageContent %} {% block ScriptBlock %}
<script>
    $(function() {
        $('#delete-data').click(function() {
            _conf("Are you sure to delete this Transaction?", 'delete_laundry', ["'" + '{% url "delete-sale" sale.pk %}' + "'"])
        })
        $('#update-status').click(function() {
            uni_modal("Updated Transaction's Status", '{% url "transacton-update-status" sale.pk %}')
        })

        $('#print').click(function() {
            var h = $('head').clone()
            h.find('title').text("Transaction Receipt - Print Details")
            h.find('link').each(function() {
                if ($(this).is('[href]')) {
                    $(this).attr('href', "{{system_host}}" + $(this).attr('href'))
                }
            })
            h.find('script').each(function() {
                if ($(this).is('[src]')) {
                    $(this).attr('src', "{{system_host}}" + $(this).attr('src'))
                }
            })
            var ph = $($('noscript#print-header').html()).clone()
            var el = "";
            var cdetails = $('#client-details').clone()
            cdetails.find('.col-lg-6').addClass('col-6')
            el += cdetails[0].outerHTML
            el += "<h5>Sale Items</h5>"
            el += $('#product_list').clone()[0].outerHTML
            el += "<h5>Damage Items</h5>"
            el += $('#return_list').clone()[0].outerHTML
            el += "<h5>Client Dues</h5>"
            el += $('#laundry_list').clone()[0].outerHTML
            el += "<h5>Brand Commission</h5>"
            el += $('#commission_list').clone()[0].outerHTML
            el += $('#payment-details').clone()[0].outerHTML

            var nw = window.open("", "_blank", "width=" + ($(window).width() * .8) + ", left=" + ($(window).width() * .1) + "height=" + ($(window).height() * .8) + ", top=" + ($(window).height() * .1) + "")
            nw.document.querySelector('head').innerHTML = h.html()
            nw.document.querySelector('body').innerHTML = ph[0].outerHTML
            nw.document.querySelector('body').innerHTML += el
            nw.document.close()
            start_loader()
            setTimeout(() => {
                nw.print()
                setTimeout(() => {
                    nw.close()
                    end_loader()
                }, 200)
            }, 300)
        })
    })

    function delete_laundry(url) {

        var _this = $('#confirm_modal .modal-body')
        $('.err-msg').remove();
        var el = $('<div>')
        el.addClass("alert alert-danger err-msg")
        el.hide()
        start_loader()
        $.ajax({
            headers: {
                "X-CSRFToken": "{{csrf_token}}"
            },
            url: url,
            dataType: 'JSON',
            error: err => {
                console.log(err)
                alert("an error occurred.")
                end_loader()
            },
            success: function(resp) {
                if (resp.status == 'success') {
                    location.replace('{% url "sale-page" %}')
                } else if (!!resp.msg) {
                    el.html(resp.msg)
                    _this.prepend(el)
                    el.show()
                } else {
                    el.html("An error occurred")
                    _this.prepend(el)
                    el.show()
                }
                end_loader()
            }

        })
    }

    function printDiv(divName) {
     var printContents = document.getElementById(divName).innerHTML;
     var originalContents = document.body.innerHTML;

     document.body.innerHTML = printContents;

     window.print();

     document.body.innerHTML = originalContents;
}
</script>
{% endblock ScriptBlock %}